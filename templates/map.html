<!DOCTYPE html>
<html>
<head>
    <title>Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/static/css/map.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- React dependencies -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Original scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>
    <script src="/static/js/map.js" defer></script>
</head>
<body>

    <div class="game-container">
        <!-- Karttaelementti, johon Leaflet luo kartan -->
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <div class="user-info-container">
        <p id="user-info"></p>
    </div>

    <div id="weather-container">
        <p id="weather-info"></p>
    </div>

    <!-- New Inventory Sidebar -->
    <div id="inventory-sidebar">
        <h3>Inventaario</h3>
        <div id="inventory-items" class="inventory-grid">
            <!-- Inventory items will be loaded here dynamically -->
            <div class="loading">Ladataan...</div>
        </div>
    </div>

    <div id="customer-info-panel"></div>

    <div id="ingame-menu">
        <button onclick="showInputIcao()">Sy√∂t√§ ICAO-koodi</button>
        <button onclick="goToShop()">Kauppa</button>
        <button onclick="goToCustomers()">Matkustajat</button>
        <button onclick="quitAndSave()">Tallenna ja lopeta</button>
        <button onclick="quitGame()">Lopeta</button>

        <div id="icao-container" style="display: none;">
            <input type="text" id="icao-input" placeholder="Sy√∂t√§ ICAO-koodi">
            <button onclick="selectIcao()">OK</button>
        </div>

        <div id="stop-flight-container" style="display: none;">
            <button onclick="stopFlight()">Pys√§yt√§ lento</button>
        </div>
    </div>

    <!-- Added notification area for item usage feedback -->
    <div id="notification" class="notification"></div>

    <!-- React component script -->
    <script type="text/babel">
        // Import necessary React hooks
        const { useState, useEffect } = React;

        const CustomerMapDisplay = () => {
            const [customer, setCustomer] = useState(null);
            const [mood, setMood] = useState({ mood_emoji: 'üòê', mood_text: '?/10' });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                // Function to fetch customer data
                const fetchCustomer = async () => {
                    try {
                        setLoading(true);
                        console.log("Fetching customer data...");

                        const response = await fetch('/get_customer_info');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        console.log("Customer data received:", data);

                        if (data.has_customer) {
                            setCustomer(data);

                            // Also fetch mood data
                            try {
                                const moodResponse = await fetch('/get_customer_mood');
                                if (!moodResponse.ok) {
                                    throw new Error(`HTTP error! status: ${moodResponse.status}`);
                                }

                                const moodData = await moodResponse.json();
                                console.log("Mood data received:", moodData);

                                if (moodData.has_customer) {
                                    setMood(moodData);
                                }
                            } catch (moodError) {
                                console.error("Error fetching mood:", moodError);
                                // Continue showing customer without mood data
                            }
                        } else {
                            console.log("No active customer found");
                            setCustomer(null);
                        }

                        setError(null);
                    } catch (error) {
                        console.error("Error fetching customer:", error);
                        setError("Failed to load customer data");
                        setCustomer(null);
                    } finally {
                        setLoading(false);
                    }
                };

                // Initial fetch
                fetchCustomer();

                // Set up the interval
                const intervalId = setInterval(fetchCustomer, 5000);

                // Clean up the interval on component unmount
                return () => clearInterval(intervalId);
            }, []);

            console.log("Rendering customer panel with state:", { customer, mood, loading, error });

            if (loading) {
                return (
                    <div className="customer-card" style={{display: 'block', visibility: 'visible'}}>
                        <h3>Nykyinen asiakas</h3>
                        <div className="customer-loading">Ladataan...</div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="customer-card" style={{display: 'block', visibility: 'visible'}}>
                        <h3>Nykyinen asiakas</h3>
                        <div className="customer-empty" style={{color: 'red'}}>{error}</div>
                    </div>
                );
            }

            if (!customer) {
                return (
                    <div className="customer-card" style={{display: 'block', visibility: 'visible'}}>
                        <h3>Nykyinen asiakas</h3>
                        <div className="customer-empty">Ei aktiivista asiakasta</div>
                    </div>
                );
            }

            return (
                <div className="customer-card" style={{display: 'block', visibility: 'visible'}}>
                    <h3>Nykyinen asiakas</h3>

                    <div className="customer-content">
                        <div className="customer-header">
                            <div className="customer-name">{customer.name || "Tuntematon asiakas"}</div>
                            <div className="customer-mood">{mood.mood_emoji || "üòê"} {mood.mood_text || "?/10"}</div>
                        </div>

                        <div className="customer-destination">
                            <span className="customer-label">M√§√§r√§np√§√§:</span> {customer.destination || "?"} {customer.destination_name ? `- ${customer.destination_name}` : ""}
                        </div>

                        <div className="customer-preferences">
                            {customer.likes && customer.likes.length > 0 && (
                                <div className="likes">
                                    <span>‚ù§Ô∏è</span> {customer.likes.join(', ')}
                                </div>
                            )}

                            {customer.dislikes && customer.dislikes.length > 0 && (
                                <div className="dislikes">
                                    <span>‚ùå</span> {customer.dislikes.join(', ')}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Debug render function to log when component renders
        const debugRender = (Component, targetElement) => {
            console.log(`Attempting to render into element:`, targetElement);
            if (!targetElement) {
                console.error("Target element for React rendering not found!");
                return;
            }

            try {
                ReactDOM.render(<Component />, targetElement);
                console.log("Component rendered successfully");
            } catch (error) {
                console.error("Error rendering React component:", error);
            }
        };

        // Render when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded, rendering customer panel");
            const customerInfoPanel = document.getElementById('customer-info-panel');
            debugRender(CustomerMapDisplay, customerInfoPanel);
        });

        // Backup render method in case DOMContentLoaded already fired
        if (document.readyState === "complete" || document.readyState === "interactive") {
            console.log("DOM already loaded, trying to render now");
            setTimeout(() => {
                const customerInfoPanel = document.getElementById('customer-info-panel');
                debugRender(CustomerMapDisplay, customerInfoPanel);
            }, 100);
        }
    </script>
</body>
</html>